<script type="module">
    // ... (Importaciones y FirebaseConfig igual) ...

    // Reemplaza ÚNICAMENTE la función initCalendar y guardarCita por estas:

    function initCalendar(userEmail, isAdmin) {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'es',
            allDaySlot: false,
            selectable: true,
            slotMinTime: "07:00:00", // Empieza a las 7 AM para mejor vista
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
            select: (info) => {
                selectedTimeInfo = info;
                if(isAdmin) {
                    document.getElementById('assign-modal').style.display = 'flex';
                } else {
                    const p = prompt("Nombre del Paciente:");
                    if(p) guardarCita(p, userEmail.toLowerCase(), '#a5c941');
                }
            },
            eventClick: (info) => {
                if(confirm("¿Deseas eliminar esta cita?")) {
                    deleteDoc(doc(db, "citas", info.event.id));
                }
            }
        });
        calendar.render();

        // EL CAMBIO ESTÁ AQUÍ: Filtro mejorado
        const citasRef = collection(db, "citas");
        const q = isAdmin ? 
            citasRef : 
            query(citasRef, where("user", "==", userEmail.toLowerCase()));

        onSnapshot(q, (snap) => {
            calendar.removeAllEvents();
            snap.forEach(d => {
                const data = d.data();
                calendar.addEvent({
                    id: d.id,
                    title: data.title,
                    start: data.start,
                    end: data.end,
                    color: data.color
                });
            });
        });
    }

    async function guardarCita(p, email, color) {
        const start = new Date(selectedTimeInfo.start);
        const end = new Date(start.getTime() + 3600000); // 1 hora exacta
        
        await addDoc(collection(db, "citas"), {
            title: p,
            start: start.toISOString(),
            end: end.toISOString(),
            user: email.toLowerCase(), // Guardamos siempre en minúsculas
            color: color || '#a5c941'
        });
        
        document.getElementById('assign-modal').style.display = 'none';
        document.getElementById('modal-patient-name').value = "";
    }
</script>
